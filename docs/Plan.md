# План дальнейшей разработки (единый бот, две кнопки)

1. Потоки входа
- Кнопка "Для мастера": WebApp → `/auth/telegram/webapp` (строгая подпись)
- Кнопка "Для клиента": WebApp → `/client/booking` (без `Auth::user()`)

2. Мастер: регистрация только после заполнения настроек
- Ввести статусы мастера: `is_active=false` при создании, `profile_completed_at`
- Онбординг `/master/register`: шаги — телефон (OTP), город/адрес, рабочие дни/время, слоты, активные услуги
- После завершения: `is_active=true`; доступ к `/master/calendar`
- Разрешить дальнейшее редактирование через `/master/settings` (уже реализовано: `SettingsController`)

3. Клиент: авто‑регистрация по Telegram
- При первом заходе в клиентский WebApp: upsert по `telegram_id` → `clients`
- Если клиент создаёт запись: сохранять `name`, `phone`, `preferred_channels`, `master_id`, `service_id`, `source='client'`
- Если только зашёл: сохранить минимум (`telegram_id`, `name?`, `last_seen_at` — добавить поле)

4. Сегментация/аналитика
- Агрегаты по интересам/записям: `client_service_stats` (client_id, service_id, bookings_count, last_booked_at)
- Отдельно "интересы" без записи: `client_service_interest` (client_id, service_id, first_seen_at, last_seen_at)
- Индексы для быстрых выборок и продаж баз по услуге/городу

5. Видимость мастеров в клиентском поиске
- Фильтр: `role='master' AND is_active=true AND профиль завершён`
- Не показывать `draft` мастеров

6. Безопасность
- Не создавать `User` в мастер‑авторизации, если мастер не найден (403 + redirect на регистрацию)
- Проверка подписи WebApp включена для мастерского потока (`webapp_skip_signature=false`)

7. Изменения фронтенда
- Страница `/master/register` (шаги онбординга)
- Клиентский поток: мягкий сбор данных при входе, формы записи — уже есть (`Client/MasterCalendar.vue`)

8. Изменения бэкенда
- Endpoint upsert клиента по `telegram_id` при входе в WebApp
- Флаги `is_active`, `profile_completed_at` у пользователя‑мастера
- Ендпоинты онбординга мастера: сохранение шагов и финальный activate
- Таблицы для агрегатов интересов/записей (миграции)

9. Очистка черновиков
- Авто‑архив/удаление мастеров `draft` без активности > N дней (команда по расписанию)

10. Мониторинг
- Логи стадий WebApp (`/debug/webapp-event` уже есть), метрики регистраций/записей

