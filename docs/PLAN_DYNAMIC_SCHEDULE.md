# План реализации: Динамическое расписание и настройки услуг

Этот документ описывает переход от фиксированных слотов к динамическому расписанию ("тетрис"), где каждая услуга имеет свою длительность и цену для конкретного мастера.

## Текущий статус: ✅ ЗАВЕРШЕНО

Весь запланированный функционал реализован и внедрен.

### 1. База данных [x]
- **Таблица:** `master_services` (pivot).
- **Действие:** Добавлена колонка `duration_minutes` (integer, default: 60).
- **Миграция:** `2025_12_20_000000_add_duration_minutes_to_master_services_table.php`

### 2. Интерфейс мастера (Frontend) [x]
- **Файл:** `resources/js/Pages/Master/Settings.vue`
- **Реализовано:**
    - Блок выбора услуг переделан под детальную настройку.
    - Для каждой услуги можно указать:
        - **Цена (₽)**
        - **Время (мин)**
    - При сохранении отправляется массив объектов с `price` и `duration`.
- **Дополнительно:** Сохранена настройка "Шаг слота" (`slot_duration_min`) для визуальной сетки календаря.

### 3. Бэкенд (Сохранение настроек) [x]
- **Файлы:** `UpdateSettingsRequest.php`, `UpdateSettingsAction.php`
- **Реализовано:**
    - Валидация массива услуг с полями `id`, `price`, `duration`.
    - Сохранение дополнительных полей в pivot-таблицу через `sync()`.

### 4. Бэкенд (Расчет слотов / Запись) [x]
- **Файл:** `app/Services/SlotService.php`
- **Реализовано:**
    - Метод `getSlotsForDate` принимает `service_id`.
    - Длительность слота рассчитывается динамически:
        - Если выбрана услуга -> берется её длительность из настроек мастера.
        - Если не выбрана -> берется "шаг слота" из настроек мастера (по умолчанию 15 мин).
    - Проверка занятости использует точную арифметику пересечений (`StartA < EndB && EndA > StartB`).
    - Учтены часовые пояса (Timezone) для корректного отображения времени.

## Итог работы системы
1. **Настройка:** Мастер задает шаг сетки (например, 15 мин) и длительность каждой услуги (например, стрижка 45 мин, окрашивание 120 мин).
2. **Просмотр:** В календаре слоты отображаются с шагом 15 мин.
3. **Запись:**
   - Если клиент/мастер выбирает услугу "Стрижка (45 мин)", система проверяет доступность интервала 45 минут начиная с каждого шага (9:00, 9:15, 9:30...).
   - Если интервал пересекается с другой записью, слот помечается как занятый.
4. **Разноцветные записи:** Реализована цветовая дифференциация записей в календаре для наглядности (разные ID записей = разные цвета).
