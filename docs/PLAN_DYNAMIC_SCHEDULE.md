# План реализации: Динамическое расписание и настройки услуг

Этот документ описывает переход от фиксированных слотов к динамическому расписанию ("тетрис"), где каждая услуга имеет свою длительность и цену для конкретного мастера.

## 1. База данных

Необходимо добавить возможность хранить длительность услуги для конкретного мастера.

- **Таблица:** `master_services` (существующая pivot-таблица).
- **Действие:** Добавить колонку `duration_minutes` (integer, default: 60).
- **Миграция:** Создать новую миграцию для изменения таблицы.

## 2. Интерфейс мастера (Frontend)

Изменить страницу настроек `resources/js/Pages/Master/Settings.vue`.

- **Удалить:** Общее поле "Длительность слота" (`slot_duration_min`).
- **Изменить:** Блок выбора услуг. Вместо простого селекта сделать список выбранных услуг.
- **Добавить:** В каждой строке выбранной услуги два поля ввода:
    - **Цена (₽)** (уже есть в БД, нужно вывести в UI).
    - **Время (мин)** (новое поле).
- **Логика:** При сохранении отправлять на бэкенд массив объектов:
  ```json
  services: [
    { "id": 1, "price": 1000, "duration": 45 },
    { "id": 5, "price": 2500, "duration": 120 }
  ]
  ```

## 3. Бэкенд (Сохранение настроек)

Обновить контроллер и экшен сохранения настроек.

- **Файл:** `app/Http/Requests/Master/UpdateSettingsRequest.php`
    - Обновить валидацию `services`. Теперь это не массив ID, а массив объектов.
- **Файл:** `app/Actions/Master/UpdateSettingsAction.php`
    - При сохранении связей `sync()` передавать дополнительные поля (`price`, `duration_minutes`) в pivot-таблицу.

## 4. Бэкенд (Расчет слотов / Запись)

Переписать логику поиска свободного времени.

- **Файл:** `app/Services/SlotService.php`
- **Изменения:**
    1. Метод `getSlotsForDate` должен принимать `service_id` (или длительность услуги).
    2. Алгоритм не должен делить день на фиксированные отрезки (10:00, 11:00).
    3. Алгоритм должен:
        - Взять рабочий интервал (например, 10:00 - 20:00).
        - "Вычесть" все занятые интервалы (существующие записи + перерывы).
        - В оставшихся свободных кусках искать окна, куда помещается `service_duration`.
        - Возвращать доступное время начала с заданным шагом (например, каждые 15 или 30 мин).

## 5. Почему это работает для всех

- **Для "сложных" мастеров:** Разные услуги (15 мин, 3 часа) укладываются плотно друг за другом.
- **Для барберов (фиксированные слоты):** Если мастер ставит всем услугам длительность 60 мин, клиенты будут видеть слоты ровно каждый час (10:00, 11:00...), что эмулирует старую систему.
