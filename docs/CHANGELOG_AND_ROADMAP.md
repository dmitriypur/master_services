# Changelog & Roadmap

## Выполненные задачи (Changelog)

### 1. Исправление отображения слотов (SlotService)
- **Проблема:** Слоты не отображались, хотя настройки графика были корректными.
- **Причина:** Несоответствие форматов дней недели. Фронтенд и база данных использовали числовые ключи (1-7), а `SlotService` ожидал строковые коды ('mon', 'tue').
- **Решение:** 
  - Переписана логика в `App\Services\SlotService.php` (метод `getSlotsForDate` и `isFree`) для использования `dayOfWeekIso` (1-7).
  - Добавлено логирование параметров для отладки.

### 2. Интерфейс календаря (Calendar.vue)
- **Улучшение:** Панель навигации ("Настройки", "Клиенты") перенесена вниз экрана и зафиксирована (`fixed bottom-4`), чтобы соответствовать дизайну страницы настроек.
- **Фикс:** Исправлена ошибка `breakDuration is not defined` (переименована переменная `breakDurationMin` -> `breakDuration`).
- **Фикс:** Добавлен отступ `pb-20` для основного контента, чтобы нижняя панель не перекрывала слоты.
- **Фикс:** Добавлен `:key="info.id"` для компонента `MasterCrmNotes`, чтобы он корректно обновлялся при открытии разных записей.

### 3. Создание записей (Appointment Logic)
- **Проблема:** Ошибка "Мастер не определён" при создании записи.
- **Причина:** `StoreAppointmentRequest` требовал роль `master` (а у текущего пользователя `superadmin`), и фронтенд не отправлял `master_id`.
- **Решение:**
  - Обновлен `StoreAppointmentRequest.php`: разрешена роль `superadmin`.
  - Обновлен `CreateAppointmentAction.php`: разрешена роль `superadmin`.
  - В `Calendar.vue` теперь явно передается `master_id` в payload.

### 4. Заметки мастера (Private Notes)
- **Проблема 1:** Заметки не сохранялись/не отображались при повторном открытии.
- **Проблема 2:** Ошибка валидации была на английском языке.
- **Решение:**
  - В `AppointmentResource.php` добавлено поле `private_notes` в ответ API.
  - В `Calendar.vue` добавлено чтение `private_notes` из ответа и передача в компонент заметок.
  - В `MasterCrmNotes.vue` добавлена поддержка `initialNotes` через props.
  - Создан файл локализации `lang/ru/validation.php` для вывода ошибок на русском языке.
  - В `MasterCrmRequest.php` поле `private_notes` сделано обязательным (`required`), как требовалось.

### 5. Offline & PWA Fixes (Telegram WebApp)
- **Проблема:** Приложение не работало без интернета в Telegram WebApp из-за динамических параметров URL (`tgWebAppData`).
- **Решение:**
  - Обновлен Service Worker (`sw.js` v6): игнорирование query-параметров при поиске в кэше, кэширование "чистых" URL.
  - Реализован "прогрев кэша" (`primeCache` в `app.js`): принудительная загрузка ресурсов при первом запуске.
  - Исправлена конфигурация `manifest.json`.

---

## План дальнейших работ (Roadmap)

### Приоритет 1: Стабилизация и UI
1. **Удалить отладочный код:**
   - Убрать `console.log` из `Calendar.vue` и `MasterCrmNotes.vue`.
   - Убрать лишнее логирование из `SlotService.php` и контроллеров.
   - Убрать блок `Debug` (красный текст) из `Calendar.vue`.
2. **Проверка мобильной верстки:**
   - Убедиться, что модальные окна (запись, инфо) корректно отображаются на мобильных устройствах (клавиатура не перекрывает кнопки).
   - Проверить работу свайпов (если планируется).

### Приоритет 2: Функциональность
3. **Редактирование записей:**
   - Сейчас можно только создать и удалить. Нужно добавить возможность изменения времени/услуги.
4. **Уведомления (Telegram/WhatsApp):**
   - Проверить реальную отправку уведомлений клиенту (сейчас это заглушки или ссылки).
5. **Клиентская база:**
   - Улучшить страницу "Клиенты": поиск, история посещений клиента.

### Приоритет 3: Технический долг
6. **Оптимизация API:**
   - Реализовать нормальный endpoint `GET /api/appointments/{id}` вместо использования `showAt` с датой и временем.
7. **Тесты:**
   - Написать Feature-тесты для создания записи с ролью `superadmin`.
   - Написать Unit-тесты для `SlotService` (проверка генерации слотов).

### Приоритет 4: Голосовой ввод (AI)
8. **Улучшение парсинга:**
   - Протестировать распознавание сложных фраз ("Запиши на завтра на стрижку в 5 вечера").
   - Добавить обратную связь пользователю (какие поля распознаны, какие нет).
