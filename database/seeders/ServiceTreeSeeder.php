<?php

declare(strict_types=1);

namespace Database\Seeders;

use App\Models\Service;
use Illuminate\Database\Seeder;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Schema;

class ServiceTreeSeeder extends Seeder
{
    public function run(): void
    {
        // Отключаем проверку внешних ключей для очистки
        Schema::disableForeignKeyConstraints();
        
        DB::table('services')->truncate();
        
        Schema::enableForeignKeyConstraints();
        
        // Сбрасываем автоинкремент (для PostgreSQL)
        if (DB::getDriverName() === 'pgsql') {
             DB::statement('ALTER SEQUENCE services_id_seq RESTART WITH 1');
        }

        $tree = [
            'Ногтевой сервис' => [
                'children' => [
                    'Маникюр' => [
                        'children' => [
                            'Классический маникюр',
                            'Аппаратный маникюр',
                            'Комбинированный маникюр',
                            'Мужской маникюр',
                            'Японский маникюр',
                        ]
                    ],
                    'Педикюр' => [
                        'children' => [
                            'Классический педикюр',
                            'Аппаратный педикюр',
                            'Кислотный педикюр',
                            'Смарт-педикюр',
                        ]
                    ],
                    'Покрытие и дизайн' => [
                        'children' => [
                            'Гель-лак (Shellac)',
                            'Выравнивание пластины',
                            'Френч',
                            'Художественная роспись',
                        ]
                    ],
                    'Наращивание ногтей' => [
                        'children' => [
                            'Наращивание гелем',
                            'Наращивание акрилом',
                            'Полигель',
                            'Коррекция',
                        ]
                    ],
                    'Уход' => [
                        'children' => [
                            'Парафинотерапия',
                            'SPA-уход для рук/ног',
                        ]
                    ],
                ]
            ],
            'Парикмахерские услуги' => [
                'children' => [
                    'Стрижки' => [
                        'children' => [
                            'Женская стрижка',
                            'Мужская стрижка',
                            'Детская стрижка',
                            'Стрижка челки',
                            'Подравнивание кончиков',
                        ]
                    ],
                    'Окрашивание' => [
                        'children' => [
                            'Окрашивание в один тон',
                            'Окрашивание корней',
                            'Мелирование',
                            'Тонирование',
                            'Сложное окрашивание (AirTouch, Шатуш)',
                        ]
                    ],
                    'Укладки и прически' => [
                        'children' => [
                            'Вечерняя укладка',
                            'Свадебная прическа',
                            'Локоны',
                            'Плетение кос',
                        ]
                    ],
                    'Уход и восстановление' => [
                        'children' => [
                            'Ботокс для волос',
                            'Кератиновое выпрямление',
                            'Нанопластика',
                            'Ламинирование',
                        ]
                    ],
                    'Наращивание волос' => [
                        'children' => [
                             'Капсульное наращивание',
                             'Ленточное наращивание',
                        ]
                    ]
                ]
            ],
            'Брови и ресницы' => [
                'children' => [
                    'Брови' => [
                        'children' => [
                            'Коррекция бровей',
                            'Окрашивание бровей',
                            'Долговременная укладка бровей',
                        ]
                    ],
                    'Ресницы' => [
                        'children' => [
                            'Наращивание ресниц (Классика)',
                            'Наращивание ресниц (2D)',
                            'Наращивание ресниц (3D)',
                            'Ламинирование ресниц',
                            'Окрашивание ресниц',
                            'Снятие ресниц',
                        ]
                    ],
                ]
            ],
            'Косметология и Эпиляция' => [
                'children' => [
                    'Эпиляция' => [
                        'children' => [
                            'Лазерная эпиляция',
                            'Шугаринг',
                            'Восковая эпиляция',
                            'Электроэпиляция',
                        ]
                    ],
                    'Уход за лицом' => [
                        'children' => [
                            'Чистка лица',
                            'Пилинг',
                            'Массаж лица',
                        ]
                    ],
                    'Инъекционная косметология' => [
                        'children' => [
                            'Мезотерапия',
                            'Биоревитализация',
                            'Контурная пластика губ',
                        ]
                    ],
                    'Перманентный макияж' => [
                        'children' => [
                            'Пудровое напыление бровей',
                            'Межресничка',
                            'Перманент губ',
                        ]
                    ],
                ]
            ],
            'Макияж' => [
                'children' => [
                    'Дневной макияж',
                    'Вечерний макияж',
                    'Свадебный макияж',
                    'Лифтинг-макияж',
                ]
            ],
            'Массаж и SPA' => [
                'children' => [
                    'Классический массаж',
                    'Спортивный массаж',
                    'Лимфодренажный массаж',
                    'Антицеллюлитный массаж',
                    'Расслабляющий массаж',
                ]
            ],
        ];

        $this->createNodes($tree, null);
    }

    private function createNodes(array $nodes, ?Service $parent): void
    {
        foreach ($nodes as $key => $value) {
            if (is_array($value) && isset($value['children'])) {
                // Это категория (узел)
                $node = Service::create([
                    'name' => $key,
                    'parent_id' => $parent ? $parent->id : -1,
                ]);
                
                // Рекурсивно создаем детей
                $this->createNodes($value['children'], $node);
            } else {
                // Это конечный лист (строка в массиве children)
                if (is_string($value)) {
                    Service::create([
                        'name' => $value,
                        'parent_id' => $parent ? $parent->id : -1,
                    ]);
                }
            }
        }
    }
}
